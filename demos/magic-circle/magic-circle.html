<!doctype html>

<html>
	<head>
		<title>Page Title</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1.0">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.8/p5.js"></script>
		<script>
			let objects = []; // objects to animate
			let count = 0;
		  	let time = 0, lastTime = 0;
			function setup() {
				createCanvas(720, 400);
				stroke(0);
				noFill()
				frameRate(60);
				background(255);
				
				// demo settings
				let circleSize = 200;
				let circleAppearDuration = 2000;
				let originVector = createVector(width/2, height/2);
				
				// keep track of the newest added animation start time
				let animationStart = 1000;
				
				// add a circle to draw
				objects.push({
					type: "circle",
					animations: [{
						prop: "endAngle",
						first: 0,
						last: TWO_PI,
						duration: circleAppearDuration, // milliseconds
						progress: 0,
						delay: animationStart
					}],
					x: width / 2,
					y: height / 2,
					radius: circleSize,
					startAngle: 0,
					endAngle: 0
				})
				
				// add some lines that surround the circle
				let numLines = 24;
				let lineLength = 30;
				for (let i = 0; i < numLines; i++) {
					// decide where the initial and final point should be
					// the initial point starts on the circle
					// the outer point grows perpendicularly to the circle's tangent
					
					let innerPoint = p5.Vector.add(
						originVector,
						p5.Vector.fromAngle(TWO_PI * i / numLines).setMag(circleSize / 2)
					);
					let outerPoint = p5.Vector.add(
						innerPoint,
						p5.Vector.fromAngle(TWO_PI * i / numLines).setMag(lineLength)
					);
					
					// add the line
					objects.push({
						type: "line",
						animations: [{
							prop: "p2",
							first: innerPoint,
							last: outerPoint,
							delay: i / numLines * circleAppearDuration + animationStart,
							duration: 1000, // milliseconds,
							progress: 0
						}, {
							prop: "color",
							first: color(0, 255 * i / numLines), // black, opacity matching first circle
							last: color(0, 255), // black, full opacity
							duration: (numLines - i - 1) / numLines * circleAppearDuration,
							progress: 0,
							delay: i / numLines * circleAppearDuration + animationStart
						}],
						p1: innerPoint,
						p2: innerPoint,
						radius: 200,
						startAngle: 0,
						endAngle: 0,
						color: color(0, 0)
					})
				}
			}
			
			function isVector(obj) {
				return obj.hasOwnProperty("x") && obj.hasOwnProperty("y");
			}
			
			function isColor(obj) {
				return obj instanceof p5.Color;
			}
			
			function draw() { 
				background(255);
				lastTime = time;
				time = millis();
				let diff = time - lastTime;
				
				// update properties
				for (let i = 0; i < objects.length; i++) {
					let o = objects[i];
					for (let j = 0; j < o.animations.length; j++) {
						let anim = o.animations[j];

						// add the current time to the progress of animation
						anim.progress = min(anim.progress + diff, anim.duration + (anim.delay || 0));
						// fix progress ratio between 0 and 1
						let progressRatio = constrain((anim.progress - (anim.delay || 0)) / anim.duration, 0, 1);
						
						// update the actual property
						if (anim.progress < anim.delay) {
							// skip when the animation hasn't started
							continue;
						}
						
						if (isVector(o[anim.prop])) {
							// is a vector, use vector lerp
							o[anim.prop] = p5.Vector.lerp(anim.first, anim.last, progressRatio);	
						} else if (isColor(o[anim.prop])) {
							o[anim.prop] = lerpColor(anim.first, anim.last, progressRatio);	
						} else {
							// is scalar, use scalar lerp
							o[anim.prop] = lerp(anim.first, anim.last, progressRatio);	
						}
						
						// TODO how to remove animations that are done?
					}
				}
				
				// drawing
				for (let i = 0; i < objects.length; i++) {
					let o = objects[i];
					
					stroke(o.color || color(0));
					if (o.type === "circle") {
						arc(o.x, o.y, o.radius, o.radius, o.startAngle, o.endAngle);
					} else if (o.type === "line") {
						line(o.p1.x, o.p1.y, o.p2.x, o.p2.y);
					}
				}
			  
				// limit the amount of time the animation runs
				count++;
				if (count > 300) {
					noLoop();
				}
			}
			
		</script>
	</head>

	<body>

	</body>
</html>